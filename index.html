<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°è³‡æœˆè–ªå¸³æœ¬ | WUCJ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .locked input, .locked select { background-color: #e5e7eb; cursor: not-allowed; pointer-events: none; }
        .tab-active { border-bottom: 3px solid #ea580c; color: #ea580c; font-weight: bold; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-money { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-weight: bold; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        #helpSection { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        #helpSection.open { max-height: 2500px; opacity: 1; }
    </style>
</head>
<body class="text-gray-700 pb-32">

<nav class="bg-white shadow-md p-3 sticky top-0 z-50">
    <div class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-lg font-bold text-gray-800 flex items-center">
                <div class="bg-orange-100 p-2 rounded-full mr-2">
                    <i class="fas fa-calculator text-orange-600"></i>
                </div>
                <span>å°è³‡æœˆè–ªå¸³æœ¬</span>
            </h1>
            <div class="flex gap-2">
                <input type="number" id="yearSelect" class="border border-gray-300 rounded-lg px-2 py-1.5 w-20 text-center font-bold text-lg bg-gray-50 focus:ring-2 focus:ring-orange-400 outline-none" inputmode="numeric" onchange="changeYear()">
                <select id="monthSelect" class="border border-gray-300 rounded-lg px-2 py-1.5 font-bold text-lg bg-gray-50 text-orange-700 outline-none focus:ring-2 focus:ring-orange-400" onchange="changeMonth()">
                </select>
            </div>
        </div>
        
        <div class="flex justify-between items-center border-t pt-2 mt-1">
            <div class="flex flex-1">
                <button onclick="switchTab('calculator')" id="btn-tab-calc" class="flex-1 text-center py-2 text-sm font-bold tab-active transition active:bg-gray-50 rounded-t-lg"><i class="fas fa-pen mr-1"></i>ç•¶æœˆè©¦ç®—</button>
                <button onclick="switchTab('report')" id="btn-tab-rep" class="flex-1 text-center py-2 text-sm font-bold text-gray-500 transition active:bg-gray-50 rounded-t-lg"><i class="fas fa-chart-pie mr-1"></i>å¹´åº¦å ±è¡¨</button>
            </div>
            
            <a href="https://vocus.cc/salon/WUCJ" target="_blank" class="ml-2 text-orange-600 border border-orange-200 bg-orange-50 px-3 py-1.5 rounded-full text-xs font-bold flex items-center shadow-sm active:scale-95 transition">
                <i class="fas fa-rss"></i> <span class="hidden md:inline ml-1">WUCJ æ²™é¾</span>
            </a>
        </div>
    </div>
</nav>

<div class="max-w-5xl mx-auto p-3 md:p-6">

    <div id="view-calculator">
        
        <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
            <button onclick="toggleHelp()" class="whitespace-nowrap bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-bold active:bg-blue-200 transition">
                <i class="fas fa-book-open mr-1"></i> èªªæ˜èˆ‡æ•™å­¸
            </button>
            <button onclick="copySettingsToAll()" class="whitespace-nowrap bg-purple-100 text-purple-700 px-4 py-2 rounded-lg text-sm font-bold active:bg-purple-200 transition">
                <i class="fas fa-clone mr-1"></i> å¥—ç”¨æ•´å¹´
            </button>
            <button onclick="toggleLock()" id="lockBtn" class="whitespace-nowrap bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold active:bg-gray-100 transition">
                <i class="fas fa-unlock mr-1"></i> é–å®š
            </button>
            <button onclick="clearCurrentMonth()" class="whitespace-nowrap bg-red-50 text-red-600 border border-red-100 px-4 py-2 rounded-lg text-sm font-bold active:bg-red-100 transition ml-auto">
                <i class="fas fa-trash-alt mr-1"></i> æ¸…ç©º
            </button>
        </div>

        <!-- èªªæ˜å€å¡Š (å«æ‰‹æ©Ÿä¸»ç•«é¢æ•™å­¸) -->
        <div id="helpSection" class="mb-4 bg-blue-50 rounded-xl border border-blue-200 shadow-inner">
            <div class="p-4 text-sm text-gray-700 space-y-4">
                
                <!-- æ‰‹æ©Ÿæ•™å­¸ -->
                <div class="bg-white p-3 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-orange-600 flex items-center mb-2"><i class="fas fa-mobile-alt mr-2"></i> åƒ App ä¸€æ¨£å¥½ç”¨ï¼åŠ å…¥æ‰‹æ©Ÿä¸»ç•«é¢</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                        <div class="flex items-start">
                            <i class="fab fa-apple text-lg mr-2 text-gray-500"></i>
                            <div>
                                <span class="font-bold">iOS (Safari)ï¼š</span><br>
                                é»æ“Šä¸‹æ–¹ <i class="fas fa-share-square"></i> åˆ†äº«æŒ‰éˆ• â†’ æ»‘å‹•é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚
                            </div>
                        </div>
                        <div class="flex items-start">
                            <i class="fab fa-android text-lg mr-2 text-green-600"></i>
                            <div>
                                <span class="font-bold">Android (Chrome)ï¼š</span><br>
                                é»æ“Šå³ä¸Šè§’ <i class="fas fa-ellipsis-v"></i> é¸å–® â†’ é¸æ“‡ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€æˆ–ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€ã€‚
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-blue-200">

                <div>
                    <h4 class="font-bold text-blue-700 flex items-center"><i class="fas fa-info-circle mr-2"></i>é—œæ–¼æ™‚è–ªè¨ˆç®—</h4>
                    <p class="mt-1">å‹åŸºæ³•è¦å®šï¼ŒåŠ ç­è²»è¨ˆç®—åŸºæº–ç‚ºã€Œå¹³æ—¥æ¯å°æ™‚å·¥è³‡é¡ã€ã€‚å…¬å¼ç‚ºï¼š<br><span class="font-mono bg-white px-1 rounded">(æœ¬ä¿¸ + è·å‹™æ´¥è²¼ + ä¼™é£Ÿæ´¥è²¼) Ã· 240</span>ã€‚</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-bold text-gray-800">ğŸ’° æ”¶å…¥é …ç›®å®šç¾©</h4>
                        <ul class="list-disc list-inside mt-1 space-y-1 text-xs">
                            <li><span class="font-bold text-blue-600">æœ¬ä¿¸/æ´¥è²¼</span>ï¼šå›ºå®šæœˆè–ªï¼Œæœƒå½±éŸ¿åŠ ç­è²»é«˜ä½ã€‚</li>
                            <li><span class="font-bold text-yellow-600">å¤§é¡çé‡‘</span>ï¼šå¦‚å¹´çµ‚ã€åˆ†ç´…ã€‚å±¬éç¶“å¸¸æ€§çµ¦èˆ‡ï¼Œ<span class="text-red-500">ä¸è¨ˆå…¥æ™‚è–ª</span>ã€‚</li>
                            <li><span class="font-bold text-purple-600">è¢«å‹•æ”¶å…¥</span>ï¼šè‚¡åˆ©æˆ–å‰¯æ¥­ï¼Œåƒ…ä¾›ç´€éŒ„ç¸½è³‡ç”¢ï¼Œèˆ‡å…¬å¸è–ªè³‡ç„¡é—œã€‚</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800">ğŸ’¸ æ‰£æ¬¾é …ç›®å®šç¾©</h4>
                        <ul class="list-disc list-inside mt-1 space-y-1 text-xs">
                            <li><span class="font-bold">å‹é€€è‡ªä»˜</span>ï¼šå¯è‡ªé¡˜æç¹³ 1%~6%ï¼Œæ­¤é‡‘é¡ä¸è¨ˆå…¥å¹´åº¦æ‰€å¾—ç¨…(ç¯€ç¨…)ã€‚</li>
                            <li><span class="font-bold">çé‡‘æ‰£ç¨…</span>ï¼šå¤§é¡çé‡‘è¶…é $88,501 éœ€é æ‰£ 5% æ‰€å¾—ç¨…ï¼Œæˆ–è¶…éæŠ•ä¿é‡‘é¡4å€éœ€æ‰£ 2.11% äºŒä»£å¥ä¿ã€‚</li>
                            <li><span class="font-bold">ç¦åˆ©å„²è“„</span>ï¼šå¦‚å…¬å¸æŒè‚¡ä¿¡è¨—æˆ–å¼·è¿«å„²è“„ã€‚</li>
                        </ul>
                    </div>
                </div>
                <div class="bg-orange-50 p-2 rounded border border-orange-100 mt-2">
                    <h4 class="font-bold text-orange-600 text-xs">âš  ç‰¹æ®Šå·¥æ™‚ï¼šå¤©ç½/é¢±é¢¨</h4>
                    <p class="text-xs mt-1">è‹¥é¢±é¢¨å¤©å‡ºå‹¤ï¼Œé€šå¸¸ä¸è¨ˆå…¥æ¯æœˆ46å°æ™‚åŠ ç­ä¸Šé™ã€‚å»ºè­°é¸æ“‡ã€Œå¤©ç½/é¢±é¢¨ã€é¡å‹ï¼Œç³»çµ±æœƒå°‡æ™‚æ•¸ç¨ç«‹çµ±è¨ˆã€‚</p>
                </div>
                <button onclick="toggleHelp()" class="w-full text-center text-blue-500 text-xs mt-2 underline">æ”¶èµ·èªªæ˜</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="inputArea">
            
            <!-- Aå€: æ”¶å…¥è¨­å®š -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
                    <span class="bg-blue-100 text-blue-600 p-1.5 rounded-md mr-2"><i class="fas fa-wallet"></i></span>
                    æ”¶å…¥ä¾†æº
                    <span class="ml-auto text-[10px] text-blue-600 bg-blue-50 px-2 py-1 rounded-full">è—è‰²é …è¨ˆå…¥æ™‚è–ª</span>
                </h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-600">æœ¬ä¿¸ (åº•è–ª)</label>
                        <input type="number" id="baseSalary" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-lg focus:ring-2 ring-blue-400 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-600">è·å‹™æ´¥è²¼</label>
                        <input type="number" id="jobAllowance" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-lg focus:ring-2 ring-blue-400 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-600">ä¼™é£Ÿæ´¥è²¼</label>
                        <input type="number" id="mealAllowance" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-lg focus:ring-2 ring-blue-400 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <hr class="border-dashed">
                    
                    <div class="flex justify-between items-center bg-yellow-50 p-2 -mx-2 rounded-lg border border-yellow-100">
                        <div class="flex flex-col">
                            <label class="text-sm font-bold text-yellow-700">å¤§é¡çé‡‘/åˆ†ç´…</label>
                            <span class="text-[10px] text-yellow-500">å¹´çµ‚, ç¸¾æ•ˆ (ä¸è¨ˆæ™‚è–ª)</span>
                        </div>
                        <input type="number" id="largeBonus" inputmode="decimal" class="input-money border border-yellow-300 bg-white rounded-lg p-2 w-32 text-right text-lg focus:ring-2 ring-yellow-500 outline-none text-gray-800" placeholder="0" oninput="calculate()">
                    </div>

                    <div class="flex justify-between items-center">
                        <label class="text-sm text-gray-500">å…¶ä»–å°é¡çé‡‘</label>
                        <input type="number" id="bonus" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-lg focus:ring-2 ring-yellow-400 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    
                    <div class="flex justify-between items-center bg-purple-50 p-2 -mx-2 rounded-lg border border-purple-100">
                        <div class="flex flex-col">
                            <label class="text-sm font-bold text-purple-700">è¢«å‹•/æ–œæ§“æ”¶å…¥</label>
                            <span class="text-[10px] text-purple-400">è‚¡åˆ©, åˆ©æ¯, å‰¯æ¥­</span>
                        </div>
                        <input type="number" id="passiveIncome" inputmode="decimal" class="input-money border border-purple-200 bg-white rounded-lg p-2 w-32 text-right text-lg focus:ring-2 ring-purple-400 outline-none text-purple-700" placeholder="0" oninput="calculate()">
                    </div>
                    
                    <div class="bg-slate-50 p-3 rounded-lg flex justify-between items-center border border-slate-100">
                        <span class="text-xs text-slate-500">å¹³æ—¥æ™‚è–ªä¼°ç®—</span>
                        <span id="hourlyRateDisplay" class="font-bold font-mono text-xl text-slate-700">0</span>
                    </div>
                </div>
            </div>

            <!-- Bå€: æ‰£æ¬¾è¨­å®š -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
                    <span class="bg-red-100 text-red-600 p-1.5 rounded-md mr-2"><i class="fas fa-file-invoice-dollar"></i></span>
                    æ¯æœˆæ‡‰æ‰£é …ç›®
                </h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-600">å‹ä¿è‡ªä»˜</label>
                        <input type="number" id="deductLabor" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-red-600 text-lg focus:ring-2 ring-red-300 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-600">å¥ä¿è‡ªä»˜</label>
                        <input type="number" id="deductHealth" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-red-600 text-lg focus:ring-2 ring-red-300 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-600">å‹é€€è‡ªä»˜ (è‡ªæ)</label>
                        <input type="number" id="deductPension" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-red-600 text-lg focus:ring-2 ring-red-300 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    
                    <div class="flex justify-between items-center bg-red-50 p-2 -mx-2 rounded-lg border border-red-100">
                        <div class="flex flex-col">
                            <label class="text-sm font-bold text-red-700">çé‡‘ç¨ç«‹æ‰£ç¨…</label>
                            <span class="text-[10px] text-red-400">é æ‰£5% / äºŒä»£å¥ä¿</span>
                        </div>
                        <input type="number" id="deductBonusTax" inputmode="decimal" class="input-money border border-red-300 bg-white rounded-lg p-2 w-32 text-right text-red-600 text-lg focus:ring-2 ring-red-300 outline-none" placeholder="0" oninput="calculate()">
                    </div>

                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-600">å…¬å¸ç¦åˆ©å„²è“„</label>
                        <input type="number" id="deductSavings" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-red-600 text-lg focus:ring-2 ring-red-300 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm font-medium text-gray-600">åœ˜éšª/é›œè²»</label>
                        <input type="number" id="deductOther" inputmode="decimal" class="input-money border border-gray-300 rounded-lg p-2 w-32 text-right text-red-600 text-lg focus:ring-2 ring-red-300 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="mt-4 p-3 bg-red-50 rounded-lg flex justify-between items-center">
                        <span class="text-xs text-red-500">æ‰£æ¬¾åˆè¨ˆ</span>
                        <div id="displayDeductTotal" class="font-bold font-mono text-red-600 text-lg">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 flex items-center">
                    <span class="bg-yellow-100 text-yellow-600 p-1.5 rounded-md mr-2"><i class="fas fa-clock"></i></span>
                    åŠ ç­ç´€éŒ„
                </h3>
                <button onclick="addOvertimeRow()" class="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md active:scale-95 transition flex items-center">
                    <i class="fas fa-plus mr-1"></i> æ–°å¢
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-center">
                    <div class="text-[10px] text-gray-500 mb-1">æ³•å®šå·¥æ™‚ (é™46h)</div>
                    <div class="font-bold text-gray-800 text-lg" id="legalHoursDisplay">0h</div>
                </div>
                <div class="bg-orange-50 p-3 rounded-lg border border-orange-200 text-center">
                    <div class="text-[10px] text-orange-600 mb-1">å¤©ç½/å…è¨ˆ</div>
                    <div class="font-bold text-orange-700 text-lg" id="exemptHoursDisplay">0h</div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left whitespace-nowrap">
                    <thead class="bg-gray-50 text-gray-600 text-xs">
                        <tr>
                            <th class="p-3 rounded-l-lg">æ—¥æœŸ</th>
                            <th class="p-3">é¡å‹</th>
                            <th class="p-3 text-center">æ™‚æ•¸</th>
                            <th class="p-3 text-right">é‡‘é¡</th>
                            <th class="p-3 rounded-r-lg w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="overtimeList" class="divide-y divide-gray-100"></tbody>
                </table>
                <div id="emptyState" class="text-center text-gray-400 py-8 bg-gray-50 rounded-lg mt-2 border border-dashed border-gray-200">
                    <p>å°šç„¡åŠ ç­ç´€éŒ„</p>
                    <p class="text-xs mt-1">é»æ“Šå³ä¸Šæ–¹ã€Œæ–°å¢ã€æŒ‰éˆ•é–‹å§‹ç´€éŒ„</p>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 w-full bg-slate-900/95 backdrop-blur text-white shadow-[0_-4px_15px_rgba(0,0,0,0.3)] z-40 pb-safe rounded-t-2xl md:rounded-none">
            <div class="max-w-5xl mx-auto p-4 flex flex-row justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-400 uppercase tracking-wider mb-0.5">æœ¬æœˆç¸½å¯¦é ˜</span>
                    <span class="text-3xl font-bold font-mono text-green-400 leading-none" id="netPay">$0</span>
                </div>
                
                <div class="flex gap-4 text-right">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-400 mb-0.5">åŠ ç­è²»</span>
                        <span class="text-lg font-bold text-yellow-400 leading-none" id="totalOtPay">$0</span>
                    </div>
                    <div class="flex flex-col pl-4 border-l border-gray-700">
                        <span class="text-[10px] text-gray-400 mb-0.5">å‹å‹™ç¸½æ”¶</span>
                        <span class="text-lg font-bold leading-none" id="totalGross">$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-report" class="hidden">
        
        <div class="grid grid-cols-2 md:flex md:justify-end gap-3 mb-6">
             <button onclick="exportYearlyExcel()" class="bg-green-600 text-white px-3 py-3 rounded-xl shadow-sm text-sm font-bold active:scale-95 transition flex justify-center items-center">
                <i class="fas fa-file-excel mr-2 text-lg"></i> åŒ¯å‡º Excel
            </button>
            <button onclick="exportJson()" class="bg-gray-600 text-white px-3 py-3 rounded-xl shadow-sm text-sm font-bold active:scale-95 transition flex justify-center items-center">
                <i class="fas fa-download mr-2 text-lg"></i> å‚™ä»½è³‡æ–™
            </button>
            <label class="bg-blue-600 text-white px-3 py-3 rounded-xl shadow-sm text-sm font-bold active:scale-95 transition cursor-pointer col-span-2 md:col-auto flex justify-center items-center">
                <i class="fas fa-upload mr-2 text-lg"></i> é‚„åŸå‚™ä»½
                <input type="file" id="importFile" class="hidden" onchange="importData(this)">
            </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-2xl shadow-lg text-white">
                <div class="text-xs opacity-80 mb-1">å¹´åº¦ç¸½ç¾é‡‘æµ (å«è¢«å‹•)</div>
                <div class="text-3xl font-bold font-mono" id="yearNetTotal">$0</div>
            </div>
            <div class="grid grid-cols-2 gap-4 md:col-span-2">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-xs text-gray-500 mb-1">å¹´åº¦åŠ ç­è²»</div>
                    <div class="text-xl font-bold font-mono text-gray-800" id="yearOtTotal">$0</div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="text-xs text-purple-600 mb-1 font-bold">å¹´åº¦è¢«å‹•æ”¶å…¥</div>
                    <div class="text-xl font-bold font-mono text-purple-700" id="yearPassiveTotal">$0</div>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6">
            <h4 class="font-bold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-orange-500"></i>è³‡ç”¢ç´¯ç©è¶¨å‹¢
            </h4>
            <div class="h-64">
                <canvas id="yearlyChart"></canvas>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 mb-8 overflow-hidden">
            <h4 class="font-bold text-gray-700 p-4 border-b bg-gray-50 flex items-center">
                <i class="fas fa-list mr-2 text-blue-500"></i>å¹´åº¦è©³ç´°æ•¸æ“š
            </h4>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left whitespace-nowrap">
                    <thead class="bg-gray-50 text-gray-600">
                        <tr>
                            <th class="p-4">æœˆä»½</th>
                            <th class="p-4 text-right">å›ºå®šè–ªè³‡</th>
                            <th class="p-4 text-right text-yellow-600">å¤§é¡çé‡‘</th>
                            <th class="p-4 text-right text-purple-600">è¢«å‹•æ”¶å…¥</th>
                            <th class="p-4 text-right text-yellow-600">åŠ ç­è²»</th>
                            <th class="p-4 text-right text-red-500">æ‰£æ¬¾</th>
                            <th class="p-4 text-right font-bold text-green-600">å¯¦é ˜ç¸½é¡</th>
                            <th class="p-4 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="yearlyTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <div class="mt-8 bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-2xl shadow-xl flex flex-col md:flex-row justify-between items-center gap-6 text-center md:text-left">
            <div>
                <h4 class="font-bold text-xl mb-2 flex justify-center md:justify-start items-center">
                    <i class="fas fa-lightbulb text-yellow-400 mr-2"></i> æƒ³å¢åŠ è¢«å‹•æ”¶å…¥ï¼Ÿ
                </h4>
                <p class="text-sm text-gray-300">æˆ‘åœ¨æ–¹æ ¼å­ Vocus åˆ†äº«é—œæ–¼å­˜è‚¡ã€ETFèˆ‡å‰¯æ¥­ç¶“ç‡Ÿçš„å¯¦æˆ°ç¶“é©—ã€‚</p>
            </div>
            <a href="https://vocus.cc/salon/WUCJ" target="_blank" class="bg-orange-500 hover:bg-orange-600 text-white px-8 py-3 rounded-full shadow-lg font-bold text-sm transition transform active:scale-95 whitespace-nowrap flex items-center ring-4 ring-orange-500/30">
                å‰å¾€ WUCJ æ²™é¾ <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>
    </div>
</div>

<script>
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let isLocked = false;
    const STORAGE_KEY = 'salary_pro_v7_help'; 
    let appData = {};

    window.onload = function() {
        const select = document.getElementById('monthSelect');
        for(let i=1; i<=12; i++) {
            let opt = document.createElement('option');
            opt.value = i; opt.text = i + "æœˆ"; select.appendChild(opt);
        }
        document.getElementById('yearSelect').value = currentYear;
        select.value = currentMonth;
        loadAllData();
        loadMonthUI();
    };

    function loadAllData() {
        const json = localStorage.getItem(STORAGE_KEY);
        appData = json ? JSON.parse(json) : {};
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    function getMonthData(y, m) {
        if (!appData[y]) appData[y] = {};
        if (!appData[y][m]) {
            appData[y][m] = {
                base: '', jobAllowance: '', mealAllowance: '', 
                bonus: '', largeBonus: '', passiveIncome: '', 
                deductLabor: '', deductHealth: '', deductPension: '', 
                deductBonusTax: '', deductSavings: '', deductOther: '',
                overtime: []
            };
        }
        return appData[y][m];
    }

    function changeYear() { currentYear = document.getElementById('yearSelect').value; loadMonthUI(); }
    function changeMonth() { currentMonth = parseInt(document.getElementById('monthSelect').value); loadMonthUI(); }
    function switchTab(tab) {
        const calc = document.getElementById('view-calculator');
        const rep = document.getElementById('view-report');
        const btnCalc = document.getElementById('btn-tab-calc');
        const btnRep = document.getElementById('btn-tab-rep');
        
        if (tab === 'calculator') {
            calc.classList.remove('hidden'); rep.classList.add('hidden');
            btnCalc.classList.add('tab-active', 'text-gray-800'); btnCalc.classList.remove('text-gray-500');
            btnRep.classList.remove('tab-active', 'text-gray-800'); btnRep.classList.add('text-gray-500');
        } else {
            calc.classList.add('hidden'); rep.classList.remove('hidden');
            btnCalc.classList.remove('tab-active', 'text-gray-800'); btnCalc.classList.add('text-gray-500');
            btnRep.classList.add('tab-active', 'text-gray-800'); btnRep.classList.remove('text-gray-500');
            updateYearlyReport();
        }
    }

    function toggleHelp() {
        document.getElementById('helpSection').classList.toggle('open');
    }

    function loadMonthUI() {
        const data = getMonthData(currentYear, currentMonth);
        document.getElementById('baseSalary').value = data.base;
        document.getElementById('jobAllowance').value = data.jobAllowance || ''; 
        document.getElementById('mealAllowance').value = data.mealAllowance || '';
        document.getElementById('largeBonus').value = data.largeBonus || ''; 
        document.getElementById('bonus').value = data.bonus;
        document.getElementById('passiveIncome').value = data.passiveIncome || ''; 
        
        document.getElementById('deductLabor').value = data.deductLabor;
        document.getElementById('deductHealth').value = data.deductHealth;
        document.getElementById('deductPension').value = data.deductPension || '';
        document.getElementById('deductBonusTax').value = data.deductBonusTax || ''; 
        document.getElementById('deductSavings').value = data.deductSavings || ''; 
        document.getElementById('deductOther').value = data.deductOther;
        
        renderOvertimeTable(data.overtime);
        calculate(false);
    }

    function calculate(shouldSave = true) {
        const base = parseFloat(document.getElementById('baseSalary').value) || 0;
        const job = parseFloat(document.getElementById('jobAllowance').value) || 0;
        const meal = parseFloat(document.getElementById('mealAllowance').value) || 0;
        const largeBonus = parseFloat(document.getElementById('largeBonus').value) || 0; 
        const bonus = parseFloat(document.getElementById('bonus').value) || 0;
        const passive = parseFloat(document.getElementById('passiveIncome').value) || 0; 
        
        const regularWage = base + job + meal;
        const hourlyRate = regularWage / 240;
        document.getElementById('hourlyRateDisplay').innerText = Math.round(hourlyRate);

        const data = getMonthData(currentYear, currentMonth);
        let totalOtPay = 0;
        let legalHours = 0;
        let exemptHours = 0; 

        data.overtime.forEach(item => {
            const h = parseFloat(item.hours) || 0;
            let pay = 0;
            if (item.type === 'disaster') {
                exemptHours += h; pay = h * hourlyRate * 2; 
            } else {
                legalHours += h;
                if (item.type === 'weekday') {
                    if (h <= 2) pay = h * 1.34 * hourlyRate;
                    else pay = (2 * 1.34 * hourlyRate) + ((h - 2) * 1.67 * hourlyRate);
                } else if (item.type === 'restday') {
                    if (h <= 2) pay = h * 1.34 * hourlyRate;
                    else if (h <= 8) pay = (2 * 1.34 * hourlyRate) + ((h - 2) * 1.67 * hourlyRate);
                    else pay = (2 * 1.34 * hourlyRate) + (6 * 1.67 * hourlyRate) + ((h - 8) * 2.67 * hourlyRate);
                } else if (item.type === 'holiday') {
                    pay = h * hourlyRate * 2;
                }
            }
            item.pay = pay;
            totalOtPay += pay;
        });

        data.overtime.forEach((item, idx) => {
            const el = document.getElementById(`ot-pay-${idx}`);
            if(el) el.innerText = Math.round(item.pay);
        });

        const legalDiv = document.getElementById('legalHoursDisplay');
        legalDiv.innerText = legalHours.toFixed(1) + 'h';
        legalDiv.className = legalHours > 46 ? "font-bold text-red-600 text-lg" : "font-bold text-gray-800 text-lg";
        document.getElementById('exemptHoursDisplay').innerText = exemptHours.toFixed(1) + 'h';

        const dLabor = parseFloat(document.getElementById('deductLabor').value) || 0;
        const dHealth = parseFloat(document.getElementById('deductHealth').value) || 0;
        const dPension = parseFloat(document.getElementById('deductPension').value) || 0; 
        const dBonusTax = parseFloat(document.getElementById('deductBonusTax').value) || 0; 
        const dSavings = parseFloat(document.getElementById('deductSavings').value) || 0;
        const dOther = parseFloat(document.getElementById('deductOther').value) || 0;
        const totalDeduct = dLabor + dHealth + dPension + dBonusTax + dSavings + dOther;
        
        document.getElementById('displayDeductTotal').innerText = totalDeduct.toLocaleString();

        const totalGross = regularWage + bonus + largeBonus + totalOtPay; 
        const netPay = totalGross + passive - totalDeduct; 

        document.getElementById('totalGross').innerText = '$' + Math.round(totalGross).toLocaleString();
        document.getElementById('totalOtPay').innerText = '$' + Math.round(totalOtPay).toLocaleString();
        document.getElementById('netPay').innerText = '$' + Math.round(netPay).toLocaleString();

        if (shouldSave) {
            data.base = document.getElementById('baseSalary').value;
            data.jobAllowance = document.getElementById('jobAllowance').value;
            data.mealAllowance = document.getElementById('mealAllowance').value;
            data.largeBonus = document.getElementById('largeBonus').value; 
            data.bonus = document.getElementById('bonus').value;
            data.passiveIncome = document.getElementById('passiveIncome').value; 
            data.deductLabor = document.getElementById('deductLabor').value;
            data.deductHealth = document.getElementById('deductHealth').value;
            data.deductPension = document.getElementById('deductPension').value; 
            data.deductBonusTax = document.getElementById('deductBonusTax').value; 
            data.deductSavings = document.getElementById('deductSavings').value;
            data.deductOther = document.getElementById('deductOther').value;
            saveData();
        }
    }

    function renderOvertimeTable(list) {
        const tbody = document.getElementById('overtimeList');
        const emptyState = document.getElementById('emptyState');
        tbody.innerHTML = '';
        if (!list || list.length === 0) { emptyState.classList.remove('hidden'); return; }
        emptyState.classList.add('hidden');
        list.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-3"><input type="date" value="${item.date}" onchange="updateOt(${index}, 'date', this.value)" class="bg-gray-50 border border-gray-200 rounded-lg p-2 w-32 text-sm outline-none focus:ring-2 focus:ring-blue-300"></td>
                <td class="p-3"><select onchange="updateOt(${index}, 'type', this.value)" class="bg-gray-50 border border-gray-200 rounded-lg p-2 w-32 text-sm outline-none focus:ring-2 focus:ring-blue-300 font-bold ${item.type === 'disaster' ? 'text-red-500' : 'text-gray-700'}"><option value="weekday" ${item.type === 'weekday' ? 'selected' : ''}>å¹³æ—¥</option><option value="restday" ${item.type === 'restday' ? 'selected' : ''}>ä¼‘æ¯æ—¥</option><option value="holiday" ${item.type === 'holiday' ? 'selected' : ''}>åœ‹å®šå‡æ—¥</option><option value="disaster" ${item.type === 'disaster' ? 'selected' : ''}>âš  å¤©ç½/é¢±é¢¨</option></select></td>
                <td class="p-3"><input type="number" inputmode="decimal" value="${item.hours}" oninput="updateOt(${index}, 'hours', this.value)" class="bg-gray-50 border border-gray-200 rounded-lg p-2 w-16 text-center font-bold text-sm outline-none focus:ring-2 focus:ring-blue-300" placeholder="0"></td>
                <td class="p-3 text-right font-mono text-blue-600 font-bold" id="ot-pay-${index}">${Math.round(item.pay || 0)}</td>
                <td class="p-3 text-center"><button onclick="removeOt(${index})" class="text-gray-300 hover:text-red-500 p-2"><i class="fas fa-times-circle text-lg"></i></button></td>`;
            tbody.appendChild(tr);
        });
        if (isLocked) { tbody.querySelectorAll('input, select, button').forEach(el => el.disabled = true); }
    }

    function addOvertimeRow() { if(isLocked) return; getMonthData(currentYear, currentMonth).overtime.push({ date: '', type: 'weekday', hours: 0, pay: 0 }); renderOvertimeTable(getMonthData(currentYear, currentMonth).overtime); calculate(); }
    function removeOt(index) { if(isLocked) return; getMonthData(currentYear, currentMonth).overtime.splice(index, 1); renderOvertimeTable(getMonthData(currentYear, currentMonth).overtime); calculate(); }
    function updateOt(index, field, val) { const data = getMonthData(currentYear, currentMonth); data.overtime[index][field] = val; if(field === 'type') renderOvertimeTable(data.overtime); calculate(); }

    function copySettingsToAll() {
        if(!confirm(`ç¢ºå®šå°‡ ${currentMonth} æœˆè¨­å®šè¤‡è£½åˆ°æ•´å¹´ï¼Ÿ\n(æ³¨æ„ï¼šå¤§é¡çé‡‘èˆ‡çé‡‘ç¨…ä¸æœƒè¤‡è£½)`)) return;
        const src = getMonthData(currentYear, currentMonth);
        for(let i=1; i<=12; i++) {
            if (i === currentMonth) continue;
            let target = getMonthData(currentYear, i);
            target.base = src.base; target.jobAllowance = src.jobAllowance; target.mealAllowance = src.mealAllowance;
            target.deductLabor = src.deductLabor; target.deductHealth = src.deductHealth; target.deductPension = src.deductPension;
            target.deductSavings = src.deductSavings; target.deductOther = src.deductOther; target.passiveIncome = src.passiveIncome;
        }
        saveData(); alert("è¤‡è£½å®Œæˆï¼");
    }

    function clearCurrentMonth() {
        if(!confirm("ç¢ºå®šæ¸…ç©ºæœ¬æœˆè³‡æ–™ï¼Ÿ")) return;
        const data = getMonthData(currentYear, currentMonth);
        data.base = ''; data.jobAllowance = ''; data.mealAllowance = ''; data.largeBonus = ''; data.bonus = ''; data.passiveIncome = '';
        data.deductLabor = ''; data.deductHealth = ''; data.deductPension = ''; data.deductBonusTax = ''; data.deductSavings = ''; data.deductOther = '';
        data.overtime = []; saveData(); loadMonthUI();
    }

    function toggleLock() {
        isLocked = !isLocked;
        const btn = document.getElementById('lockBtn');
        document.getElementById('inputArea').classList.toggle('locked');
        const inputs = document.getElementById('overtimeList').querySelectorAll('input, select, button');
        inputs.forEach(el => el.disabled = isLocked);
        btn.innerHTML = isLocked ? '<i class="fas fa-lock text-red-500 mr-1"></i> è§£é–' : '<i class="fas fa-unlock mr-1"></i> é–å®š';
    }

    let chartInstance = null;
    function updateYearlyReport() {
        let labels = []; let nets = []; let ots = []; let stats = [];
        let sumNet = 0; let sumOt = 0; let sumOtHours = 0; let sumPassive = 0;

        for(let i=1; i<=12; i++) {
            const d = appData[currentYear]?.[i];
            const base = parseFloat(d?.base)||0; const job = parseFloat(d?.jobAllowance)||0; const meal = parseFloat(d?.mealAllowance)||0;
            const lBonus = parseFloat(d?.largeBonus)||0; const bonus = parseFloat(d?.bonus)||0; const passive = parseFloat(d?.passiveIncome)||0;
            const ot = d?.overtime?.reduce((acc, c) => acc + (c.pay||0), 0) || 0;
            const ded = (parseFloat(d?.deductLabor)||0) + (parseFloat(d?.deductHealth)||0) + (parseFloat(d?.deductPension)||0) + (parseFloat(d?.deductBonusTax)||0) + (parseFloat(d?.deductSavings)||0) + (parseFloat(d?.deductOther)||0);
            
            const net = base+job+meal+lBonus+bonus+passive+ot-ded;
            const hours = d?.overtime?.reduce((acc, c) => acc + (parseFloat(c.hours)||0), 0) || 0;
            
            sumNet += net; sumOt += ot; sumOtHours += hours; sumPassive += passive;
            labels.push(i + 'æœˆ'); nets.push(net); ots.push(ot);
            
            if (base+ot+passive+lBonus > 0) { 
                stats.push({ m: i, base: base+job+meal+bonus, lBonus: lBonus, passive: passive, ot: ot, ded: ded, net: net });
            }
        }
        document.getElementById('yearNetTotal').innerText = "$" + Math.round(sumNet).toLocaleString();
        document.getElementById('yearOtTotal').innerText = "$" + Math.round(sumOt).toLocaleString();
        document.getElementById('yearPassiveTotal').innerText = "$" + Math.round(sumPassive).toLocaleString();
        document.getElementById('yearOtHours').innerText = sumOtHours.toFixed(1) + "h";

        const ctx = document.getElementById('yearlyChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'å¯¦é ˜ç¸½é¡', data: nets, backgroundColor: '#34d399', borderRadius: 4 }, { label: 'åŠ ç­è²»', data: ots, type: 'line', borderColor: '#f59e0b', borderWidth: 2 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        
        const tbody = document.getElementById('yearlyTableBody');
        tbody.innerHTML = '';
        if (stats.length === 0) tbody.innerHTML = '<tr><td colspan="8" class="p-6 text-center text-gray-400">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œè«‹å…ˆè‡³ã€Œç•¶æœˆè©¦ç®—ã€è¼¸å…¥ã€‚</td></tr>';
        else stats.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-4 text-center font-bold">${s.m}æœˆ</td><td class="p-4 text-right text-gray-600">${s.base.toLocaleString()}</td><td class="p-4 text-right text-yellow-600">${s.lBonus > 0 ? s.lBonus.toLocaleString() : '-'}</td><td class="p-4 text-right text-purple-600">${s.passive > 0 ? s.passive.toLocaleString() : '-'}</td><td class="p-4 text-right text-yellow-600 font-medium">${s.ot > 0 ? s.ot.toLocaleString() : '-'}</td><td class="p-4 text-right text-red-400">${s.ded > 0 ? '-' + s.ded.toLocaleString() : '-'}</td><td class="p-4 text-right font-bold text-green-600">${s.net.toLocaleString()}</td><td class="p-4 text-center"><button onclick="jumpToMonth(${s.m})" class="text-blue-500 bg-blue-50 hover:bg-blue-100 rounded-lg px-3 py-1 text-xs font-bold transition">ç·¨è¼¯</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function jumpToMonth(m) { document.getElementById('monthSelect').value = m; changeMonth(); switchTab('calculator'); }
    function exportYearlyExcel() {
        const wb = XLSX.utils.book_new();
        let wsData = [["å¹´åº¦è–ªè³‡å ±è¡¨", currentYear + "å¹´"], ["æœˆä»½", "æœ¬ä¿¸", "è·å‹™æ´¥è²¼", "ä¼™é£Ÿæ´¥è²¼", "å¤§é¡çé‡‘", "å…¶ä»–çé‡‘", "è¢«å‹•æ”¶å…¥", "åŠ ç­è²»", "åŠ ç­æ™‚æ•¸", "å‹é€€è‡ªä»˜", "çé‡‘æ‰£ç¨…", "ç¦åˆ©å„²è“„", "å…¶ä»–æ‰£æ¬¾", "å¯¦é ˜é‡‘é¡"]];
        for(let i=1; i<=12; i++) {
            const d = appData[currentYear]?.[i];
            if(d) {
                const base = parseFloat(d.base)||0; const job = parseFloat(d.jobAllowance)||0; const meal = parseFloat(d.mealAllowance)||0;
                const lBonus = parseFloat(d.largeBonus)||0; const bonus = parseFloat(d.bonus)||0; const passive = parseFloat(d.passiveIncome)||0;
                const ot = d.overtime.reduce((acc, c) => acc + (c.pay||0), 0);
                const dedPen = parseFloat(d.deductPension)||0; const dedTax = parseFloat(d.deductBonusTax)||0;
                const dedSav = parseFloat(d.deductSavings)||0; const dedOth = (parseFloat(d.deductLabor)||0) + (parseFloat(d.deductHealth)||0) + (parseFloat(d.deductOther)||0);
                const net = base+job+meal+lBonus+bonus+passive+ot-(dedPen+dedTax+dedSav+dedOth);
                const hours = d.overtime.reduce((acc, c) => acc + (parseFloat(c.hours)||0), 0);
                wsData.push([i, base, job, meal, lBonus, bonus, passive, Math.round(ot), hours, dedPen, dedTax, dedSav, dedOth, Math.round(net)]);
            }
        }
        const ws = XLSX.utils.aoa_to_sheet(wsData); XLSX.utils.book_append_sheet(wb, ws, "å¹´åº¦ç¸½è¡¨"); XLSX.writeFile(wb, `Salary_Export_${currentYear}.xlsx`);
    }

    function exportJson() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `Salary_Backup_${currentYear}.json`);
        document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = function(e) {
            try { const raw = JSON.parse(e.target.result); if (typeof raw === 'object') { appData = raw; saveData(); alert("åŒ¯å…¥æˆåŠŸï¼"); location.reload(); } else { alert("æ ¼å¼éŒ¯èª¤"); }
            } catch (err) { alert("æª”æ¡ˆææ¯€"); }
        }; reader.readAsText(file);
    }
</script>
</body>
</html>
